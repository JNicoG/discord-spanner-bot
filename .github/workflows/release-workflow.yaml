name: Release Workflow

on:
  workflow_dispatch:
  # No inputs added - major or minor releases will require manually incrementing the respective version number
  # in the pom.xml file prior to merging into main branch

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: github.event.head_commit.author.name != 'GitHub Action'
    outputs:
      release_version: ${{ steps.extract_version.outputs.release_version }}
      next_version: ${{ steps.extract_version.outputs.next_version }}
      release_tag: ${{ steps.extract_version.outputs.release_tag }}
    steps:
      - name: Checkout code with release token
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'zulu'
          cache: maven

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Extract current version
        id: extract_version
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Remove -SNAPSHOT if present
          RELEASE_VERSION=${CURRENT_VERSION%-SNAPSHOT}
          ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)

          IFS='.' read -r -a VERSION_PARTS <<< "$RELEASE_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}-SNAPSHOT"
          
          # Export to Job Outputs
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=${ARTIFACT_ID}-v${RELEASE_VERSION}" >> $GITHUB_OUTPUT

      - name: Update POM to release version
        run: mvn versions:set -DnewVersion=${{ steps.extract_version.outputs.release_version }} -DgenerateBackupPoms=false

      - name: Commit and Tag Release
        run: |
          git add pom.xml
          git commit -m "Release version ${{ steps.extract_version.outputs.release_version }}"
          git tag ${{ steps.extract_version.outputs.release_tag }}
          git push origin ${{ steps.extract_version.outputs.release_tag }}
          git push origin HEAD:main

  deploy-github-packages:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Tagged Release
        uses: actions/checkout@v5
        with:
          ref: refs/tags/${{ needs.create-release.outputs.release_tag }}

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'zulu'
          cache: maven

      - name: Deploy to GitHub Packages
        run: mvn deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ needs.create-release.outputs.release_tag }}
          name: Release v${{ needs.create-release.outputs.release_version }}
          draft: false
          prerelease: false
          files: target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-heroku:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Tagged Release
        uses: actions/checkout@v5
        with:
          ref: refs/tags/${{ needs.create-release.outputs.release_tag }}

      # Manually install Heroku CLI for Ubuntu 24.04 (latest)
      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.14.15
        with:
          heroku_api_key: ${{secrets.HEROKU_API_KEY}}
          heroku_app_name: ${{secrets.HEROKU_APP_NAME}}
          heroku_email: ${{secrets.HEROKU_EMAIL}}
          branch: "HEAD"

  prepare-next-dev:
    needs: [create-release, deploy-github-packages, deploy-heroku]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout latest main
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'zulu'
          cache: maven

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Update to next development version
        run: mvn versions:set -DnewVersion=${{ needs.create-release.outputs.next_version }} -DgenerateBackupPoms=false

      - name: Commit next development version
        run: |
          git add pom.xml
          git commit -m "Prepare for next development iteration ${{ needs.create-release.outputs.next_version }}"
          git push origin HEAD:main